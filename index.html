<!DOCTYPE html>
<html>
<head>
    <title>PDBView - Molecular Viewer</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background: #0f0f0f;
            color: #e0e0e0;
            overflow: hidden;
            height: 100vh;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        .viewer-section {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            background: #111111;
            position: relative;
        }
        
        .controls-section {
            width: 320px;
            background: #1a1a1a;
            border-left: 1px solid #333333;
            padding: 20px;
            overflow-y: auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .header h1 {
            font-size: 22px;
            font-weight: 600;
            color: #ffffff;
            margin: 0;
            letter-spacing: -0.5px;
        }
        
        .header .subtitle {
            font-size: 12px;
            color: #888888;
            margin-top: 4px;
            font-weight: 300;
        }
        
        /* tab navigation */
        .tab-container {
            margin-bottom: 16px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .tab-nav {
            display: flex;
            background: #1a1a1a;
            border-radius: 6px 6px 0 0;
            border: 1px solid #333333;
            border-bottom: none;
            overflow: hidden;
            width: fit-content;
        }
        
        .tab-button {
            padding: 12px 20px;
            background: #262626;
            color: #aaaaaa;
            border: none;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s ease;
            border-right: 1px solid #333333;
            margin: 0;
            width: auto;
        }
        
        .tab-button:last-child {
            border-right: none;
        }
        
        .tab-button.active {
            background: #333333;
            color: #ffffff;
        }
        
        .tab-button:hover:not(.active) {
            background: #2f2f2f;
            color: #cccccc;
        }
        
        .tab-content {
            position: relative;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
                .tab-panel {
            display: none;
            height: 100%;
            flex: 1;
            min-height: 0;
        }

        .tab-panel.active {
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        #viewer-container {
            flex: 1;
            background: #000000;
            border: 1px solid #333333;
            border-radius: 8px;
            position: relative;
            margin-bottom: 16px;
            height: 100%;
            min-height: 500px;
        }
        
        .control-panel {
            background: #1f1f1f;
            border: 1px solid #2a2a2a;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 12px;
        }
        
        .control-panel h3 {
            margin: 0 0 12px 0;
            font-size: 13px;
            color: #cccccc;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .control-group {
            margin-bottom: 12px;
        }
        
        label {
            display: block;
            font-size: 11px;
            color: #aaaaaa;
            margin-bottom: 6px;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        input, select {
            width: 100%;
            padding: 10px 12px;
            background: #262626;
            border: 1px solid #404040;
            border-radius: 4px;
            color: #e0e0e0;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            transition: border-color 0.2s ease;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #555555;
        }
        
        button {
            width: 100%;
            padding: 10px 12px;
            background: #2a2a2a;
            color: #ffffff;
            border: 1px solid #404040;
            border-radius: 4px;
            font-family: 'Inter', sans-serif;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        button:hover {
            background: #333333;
            border-color: #555555;
        }
        
        button:active {
            background: #252525;
        }
        
        .file-input {
            position: relative;
        }
        
        .file-input input[type=file] {
            position: absolute;
            left: -9999px;
        }
        
        .file-label {
            display: block;
            width: 100%;
            padding: 10px 12px;
            background: #262626;
            border: 1px solid #404040;
            border-radius: 4px;
            color: #aaaaaa;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .file-label:hover {
            background: #2f2f2f;
            border-color: #555555;
            color: #cccccc;
        }
        
        .status-display {
            background: #1a1a1a;
            border: 1px solid #333333;
            border-radius: 6px;
            padding: 12px;
            font-size: 12px;
            min-height: 44px;
            color: #cccccc;
            font-family: 'Inter', sans-serif;
            font-weight: 400;
        }
        
        .error {
            color: #ff6b6b !important;
            border-color: #ff6b6b !important;
        }
        
        .success {
            color: #51cf66 !important;
            border-color: #51cf66 !important;
        }
        
        .quick-load {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-top: 8px;
        }
        
        .quick-load button {
            font-size: 10px;
            padding: 8px 6px;
            margin: 0;
        }
        
        .molecular-stats {
            background: #1a1a1a;
            border: 1px solid #333333;
            border-radius: 6px;
            padding: 12px;
            font-size: 11px;
            color: #aaaaaa;
        }
        
        .stat-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-weight: 400;
        }
        
        .stat-line:last-child {
            margin-bottom: 0;
        }
        
        .stat-value {
            color: #ffffff;
            font-weight: 500;
        }
        
        /* Scrollbar styling */
        .controls-section::-webkit-scrollbar {
            width: 6px;
        }
        
        .controls-section::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        .controls-section::-webkit-scrollbar-thumb {
            background: #404040;
            border-radius: 3px;
        }
        
        .controls-section::-webkit-scrollbar-thumb:hover {
            background: #555555;
        }
        
        /* amino acid detail modal */
        .amino-acid-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 300px;
            max-height: calc(100vh - 120px);
            background: #1a1a1a;
            border: 1px solid #333333;
            border-radius: 8px;
            padding: 20px;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            display: none;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #333333;
            padding-bottom: 10px;
        }
        
        .modal-title {
            font-size: 16px;
            font-weight: 600;
            color: #ffffff;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: #aaaaaa;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            width: auto;
            margin: 0;
        }
        
        .modal-close:hover {
            color: #ffffff;
        }
        
        .amino-acid-structure {
            text-align: center;
            margin: 15px 0;
            padding: 15px;
            background: #262626;
            border-radius: 6px;
            border: 1px solid #333333;
        }
        
        .structure-img {
            max-width: 100%;
            height: auto;
            background: white;
            border-radius: 4px;
            padding: 10px;
        }
        
        .amino-acid-info {
            margin-top: 15px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
        }
        
        .info-label {
            color: #aaaaaa;
            font-weight: 500;
        }
        
        .info-value {
            color: #ffffff;
            font-weight: 400;
        }
        
        .amino-acid-description {
            margin-top: 15px;
            padding: 12px;
            background: #262626;
            border-radius: 6px;
            border-left: 3px solid #555555;
            font-size: 11px;
            color: #cccccc;
                         line-height: 1.4;
         }
         
         /* literature tab styles */
         .literature-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .literature-header {
            padding: 15px;
            background: #1a1a1a;
            border: 1px solid #333333;
            border-radius: 6px 6px 0 0;
            border-bottom: none;
        }
        
        .literature-title {
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 8px;
        }
        
        .literature-info {
            font-size: 11px;
            color: #aaaaaa;
        }
        
        .papers-list {
            flex: 1;
            background: #000000;
            border: 1px solid #333333;
            border-radius: 0 0 6px 6px;
            overflow-y: auto;
            padding: 15px;
        }
        
        .paper-item {
            background: #1a1a1a;
            border: 1px solid #333333;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .paper-item:hover {
            background: #262626;
            border-color: #555555;
        }
        
        .paper-title {
            font-size: 13px;
            font-weight: 500;
            color: #ffffff;
            margin-bottom: 8px;
            line-height: 1.3;
        }
        
        .paper-authors {
            font-size: 11px;
            color: #aaaaaa;
            margin-bottom: 6px;
        }
        
        .paper-journal {
            font-size: 11px;
            color: #888888;
            margin-bottom: 8px;
        }
        
        .paper-abstract {
            font-size: 10px;
            color: #cccccc;
            line-height: 1.4;
            max-height: 60px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
        }
        
        .loading-literature {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #aaaaaa;
            font-size: 12px;
        }
        
        .no-literature {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #888888;
            font-size: 12px;
            text-align: center;
            flex-direction: column;
        }

        /* raw pdb tab styles */
        .rawpdb-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            background: #0f0f0f;
            min-height: 0;
        }

        .rawpdb-header {
            padding: 15px 20px;
            border-bottom: 1px solid #333;
            background: #1a1a1a;
        }

        .rawpdb-title {
            font-size: 14px;
            font-weight: 500;
            color: #fff;
            margin-bottom: 5px;
        }

        .rawpdb-info {
            font-size: 11px;
            color: #888;
        }

        .rawpdb-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto;
            padding: 0;
            max-height: calc(100vh - 200px);
        }

        .no-rawpdb {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #888888;
            font-size: 12px;
            text-align: center;
            flex-direction: column;
        }

        .pdb-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Courier New', monospace;
            font-size: 10px;
            background: #0f0f0f;
            table-layout: fixed;
        }

        .pdb-table th {
            background: #2a2a2a;
            color: #fff;
            padding: 8px 6px;
            text-align: left;
            border-bottom: 1px solid #555;
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .pdb-table th:nth-child(1) { width: 60px; }
        .pdb-table th:nth-child(2) { width: 80px; }
        .pdb-table th:nth-child(3) { width: calc(100% - 140px); }

        .pdb-table td {
            padding: 4px 6px;
            border-bottom: 1px solid #333;
            color: #ddd;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .pdb-table tr:nth-child(even) {
            background: #1a1a1a;
        }

        .pdb-table tr:hover {
            background: #2a2a2a;
        }

        .record-type {
            font-weight: bold;
            color: #4a9eff;
        }

        .record-header {
            background: #333 !important;
            color: #fff !important;
            font-weight: bold;
        }

        .record-atom {
            color: #ffaa44;
        }

        .record-hetatm {
            color: #ff6b6b;
        }

        .record-conect {
            color: #51cf66;
        }

        .pdb-filters {
            padding: 8px 15px;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .pdb-filter-dropdown {
            background: #2a2a2a;
            border: 1px solid #555;
            color: #ddd;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 11px;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 140px;
            outline: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23888' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 8px center;
            background-repeat: no-repeat;
            background-size: 12px;
            padding-right: 32px;
            appearance: none;
        }

        .pdb-filter-dropdown:hover {
            background: #3a3a3a;
            border-color: #666;
        }

        .pdb-filter-dropdown:focus {
            background: #3a3a3a;
            border-color: #4a9eff;
            box-shadow: 0 0 0 2px rgba(74, 158, 255, 0.2);
        }

        .pdb-filter-dropdown option {
            background: #2a2a2a;
            color: #ddd;
            padding: 4px;
        }

        /* fast grid styles */
        .fast-grid-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            background: #0f0f0f;
            position: relative;
        }

        .fast-grid-header {
            display: flex;
            background: #2a2a2a;
            border-bottom: 2px solid #555;
            position: sticky;
            top: 0;
            z-index: 100;
            font-family: 'Courier New', monospace;
            font-size: 10px;
            font-weight: 500;
        }

        .fast-grid-header-cell {
            padding: 8px 6px;
            color: #fff;
            border-right: 1px solid #555;
            display: flex;
            align-items: center;
        }

        .fast-grid-header-cell:nth-child(1) { width: 60px; min-width: 60px; }
        .fast-grid-header-cell:nth-child(2) { width: 80px; min-width: 80px; }
        .fast-grid-header-cell:nth-child(3) { flex: 1; }

        .fast-grid-viewport {
            flex: 1;
            overflow: auto;
            position: relative;
            background: #0f0f0f;
        }

        .fast-grid-content {
            position: relative;
        }

        .fast-grid-row {
            display: flex;
            position: absolute;
            left: 0;
            right: 0;
            height: 24px;
            border-bottom: 1px solid #333;
            font-family: 'Courier New', monospace;
            font-size: 10px;
            transition: background-color 0.1s;
        }

        .fast-grid-row:nth-child(even) {
            background: #1a1a1a;
        }

        .fast-grid-row:hover {
            background: #2a2a2a !important;
        }

        .fast-grid-cell {
            padding: 4px 6px;
            color: #ddd;
            border-right: 1px solid #333;
            display: flex;
            align-items: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .fast-grid-cell:nth-child(1) { width: 60px; min-width: 60px; }
        .fast-grid-cell:nth-child(2) { width: 80px; min-width: 80px; }
        .fast-grid-cell:nth-child(3) { flex: 1; }

        .fast-grid-stats {
            padding: 8px 15px;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            font-size: 10px;
            color: #888;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .fast-grid-performance {
            font-size: 9px;
            color: #51cf66;
        }
        
        .paper-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: none;
            padding: 20px;
        }
        
        .paper-viewer-content {
            background: #1a1a1a;
            border: 1px solid #333333;
            border-radius: 8px;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .paper-viewer-header {
            padding: 15px 20px;
            border-bottom: 1px solid #333333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .paper-viewer-title {
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
        }
        
        .paper-viewer-close {
            background: none;
            border: none;
            color: #aaaaaa;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            width: auto;
            margin: 0;
        }
        
        .paper-viewer-close:hover {
            color: #ffffff;
        }
        
        .paper-viewer-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .paper-detail {
            color: #cccccc;
            line-height: 1.6;
        }
        
        .paper-detail h3 {
            color: #ffffff;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .paper-detail .detail-section {
            margin-bottom: 20px;
        }
        
        .paper-detail .detail-label {
            color: #aaaaaa;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }
        
        .paper-detail .detail-value {
            color: #ffffff;
            font-size: 12px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="viewer-section">
            <div class="header">
                <h1>PDBView</h1>
                <div class="subtitle">Molecular Structure Viewer</div>
            </div>
            
            <div class="tab-container">
                <div class="tab-nav">
                                    <button class="tab-button active" onclick="switchTab('3d-view')">3D View</button>
                <button class="tab-button" onclick="switchTab('literature')">Literature</button>
                <button class="tab-button" onclick="switchTab('rawpdb')">Raw PDB</button>
                </div>
                
                <div class="tab-content">
                    <!-- 3D View Tab -->
                    <div id="3d-view-panel" class="tab-panel active">
                        <div id="viewer-container"></div>
                        
                        <!-- amino acid detail modal -->
                        <div id="amino-acid-modal" class="amino-acid-modal">
                            <div class="modal-header">
                                <div class="modal-title" id="modal-title">Amino Acid Details</div>
                                <button class="modal-close" onclick="closeAminoAcidModal()">&times;</button>
                            </div>
                            
                            <div class="amino-acid-structure" id="amino-acid-structure">
                                <div id="structure-placeholder">Select an amino acid to view its structure</div>
                            </div>
                            
                            <div class="amino-acid-info" id="amino-acid-info">
                                <!-- amino acid information will be populated here -->
                            </div>
                            
                            <div class="amino-acid-description" id="amino-acid-description">
                                <!-- amino acid description will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Literature Tab -->
                    <div id="literature-panel" class="tab-panel">
                        <div class="literature-container">
                            <div class="literature-header">
                                <div class="literature-title" id="literature-title">Related Publications</div>
                                <div class="literature-info" id="literature-info">Select a protein structure to view related research papers</div>
                            </div>
                            <div class="papers-list" id="papers-list">
                                <div class="no-literature">
                                    <div>No protein loaded</div>
                                    <div style="margin-top: 5px; font-size: 10px;">Load a PDB structure to see related publications</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Raw PDB Tab -->
                    <div id="rawpdb-panel" class="tab-panel">
                        <div class="rawpdb-container">
                            <div class="rawpdb-header">
                                <div class="rawpdb-title" id="rawpdb-title">Raw PDB Data</div>
                                <div class="rawpdb-info" id="rawpdb-info">Load a structure to view formatted PDB data</div>
                            </div>
                            <div class="rawpdb-content" id="rawpdb-content">
                                <div class="no-rawpdb">
                                    <div>No structure loaded</div>
                                    <div style="margin-top: 5px; font-size: 10px;">Load a PDB structure to view formatted data</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="status-display" class="status-display">
                Ready to load molecular structure...
            </div>
        </div>
        
        <div class="controls-section">
            <div class="control-panel">
                <h3>Load Structure</h3>
                <div class="control-group">
                    <label for="pdb-id">PDB ID</label>
                    <input type="text" id="pdb-id" placeholder="e.g., 1BNA" value="1BNA">
                    <button onclick="loadPDBFromId()">Load from Database</button>
                </div>
                
                <div class="control-group">
                    <label>Upload File</label>
                    <div class="file-input">
                        <input type="file" id="pdb-file" accept=".pdb" onchange="loadPDBFromFile()">
                        <label for="pdb-file" class="file-label">Choose PDB File</label>
                    </div>
                </div>
                
                <div class="quick-load">
                    <button onclick="quickLoad('1BNA')">DNA</button>
                    <button onclick="quickLoad('1CRN')">Protein</button>
                    <button onclick="quickLoad('2IGY')">Antibody</button>
                    <button onclick="quickLoad('6VXX')">Spike</button>
                </div>
            </div>
            
            <div class="control-panel">
                <h3>Visualization</h3>
                <div class="control-group">
                    <label for="style-select">Style</label>
                    <select id="style-select" onchange="updateStyle()">
                        <option value="cartoon">Cartoon</option>
                        <option value="stick">Stick</option>
                        <option value="sphere">Sphere</option>
                        <option value="line">Line</option>
                        <option value="cross">Cross</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="color-select">Color Scheme</label>
                    <select id="color-select" onchange="updateStyle()">
                        <option value="spectrum">Spectrum</option>
                        <option value="chainHetatm">Chain</option>
                        <option value="residue">Residue</option>
                        <option value="atom">Atom Type</option>
                        <option value="white">White</option>
                        <option value="red">Red</option>
                        <option value="blue">Blue</option>
                        <option value="green">Green</option>
                    </select>
                </div>
            </div>
            
            <div class="control-panel">
                <h3>View Controls</h3>
                <button onclick="centerView()">Center View</button>
                <button onclick="clearViewer()">Clear</button>
                <button onclick="toggleFullscreen()">Fullscreen</button>
                <button id="interactive-btn" onclick="toggleInteractiveMode()">Interactive Mode: OFF</button>
            </div>
            
            <div class="control-panel">
                <h3>Structure Info</h3>
                <div id="molecular-stats" class="molecular-stats">
                    <div class="stat-line"><span>Status:</span><span class="stat-value">Standby</span></div>
                    <div class="stat-line"><span>Atoms:</span><span class="stat-value">--</span></div>
                    <div class="stat-line"><span>Chains:</span><span class="stat-value">--</span></div>
                    <div class="stat-line"><span>Residues:</span><span class="stat-value">--</span></div>
                </div>
            </div>
            

        </div>
    </div>

    <!-- paper viewer modal -->
    <div id="paper-viewer" class="paper-viewer">
        <div class="paper-viewer-content">
            <div class="paper-viewer-header">
                <div class="paper-viewer-title" id="paper-viewer-title">Paper Details</div>
                <button class="paper-viewer-close" onclick="closePaperViewer()">&times;</button>
            </div>
            <div class="paper-viewer-body" id="paper-viewer-body">
                <!-- paper content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- include required libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://3dmol.org/build/3Dmol-min.js"></script>
    
    <script>
        let viewer;
        let currentModel;
        let interactiveMode = false;
        let selectedAtoms = [];
        let currentPdbId = null;
        let literatureCache = {};
        let rawPdbData = null;
        
        // fast grid variables
        let fastGrid = {
            data: [],
            filteredData: [],
            currentFilter: 'all',
            visibleRows: [],
            rowHeight: 24,
            containerHeight: 0,
            scrollTop: 0,
            startIndex: 0,
            endIndex: 0,
            buffer: 10,
            container: null,
            viewport: null,
            header: null
        };
        
        $(document).ready(function() {
            // initialize the 3dmol.js viewer
            initializeViewer();
            
            // load default molecule
            loadPDBFromId();
            
            // handle window resize for fast grid
            window.addEventListener('resize', () => {
                if (fastGrid.viewport) {
                    updateFastGridDimensions();
                    updateFastGridView();
                }
            });
        });
        
        function initializeViewer() {
            let element = $('#viewer-container');
            if (element.length === 0) {
                console.error('Viewer container not found');
                return;
            }
            
            viewer = $3Dmol.createViewer(element, {
                defaultcolors: $3Dmol.elementColors.rasmol,
                backgroundColor: 'black'
            });
            
            // ensure viewer is properly sized
            setTimeout(() => {
                if (viewer) {
                    viewer.resize();
                    viewer.render();
                }
            }, 100);
        }
        
        function showMessage(message, type = 'info') {
            const statusDisplay = $('#status-display');
            statusDisplay.removeClass('error success');
            
            if (type === 'error') {
                statusDisplay.addClass('error');
            } else if (type === 'success') {
                statusDisplay.addClass('success');
            }
            
            statusDisplay.text(message);
        }
        
        function updateMolecularStats(model) {
            const stats = $('#molecular-stats');
            if (model) {
                const atoms = model.selectedAtoms({}).length;
                const chains = [...new Set(model.selectedAtoms({}).map(atom => atom.chain))].length;
                const residues = [...new Set(model.selectedAtoms({}).map(atom => atom.resi))].length;
                
                stats.html(`
                    <div class="stat-line"><span>Status:</span><span class="stat-value">Loaded</span></div>
                    <div class="stat-line"><span>Atoms:</span><span class="stat-value">${atoms}</span></div>
                    <div class="stat-line"><span>Chains:</span><span class="stat-value">${chains}</span></div>
                    <div class="stat-line"><span>Residues:</span><span class="stat-value">${residues}</span></div>
                `);
            } else {
                stats.html(`
                    <div class="stat-line"><span>Status:</span><span class="stat-value">Standby</span></div>
                    <div class="stat-line"><span>Atoms:</span><span class="stat-value">--</span></div>
                    <div class="stat-line"><span>Chains:</span><span class="stat-value">--</span></div>
                    <div class="stat-line"><span>Residues:</span><span class="stat-value">--</span></div>
                `);
            }
        }
        
        function quickLoad(pdbId) {
            $('#pdb-id').val(pdbId);
            loadPDBFromId();
        }
        
        function loadPDBFromId() {
            const pdbId = $('#pdb-id').val().trim().toUpperCase();
            
            if (!pdbId) {
                showMessage('Please enter a PDB ID', 'error');
                return;
            }
            
            showMessage(`Loading ${pdbId}...`);
            
            // clear previous model
            viewer.removeAllModels();
            
            // fetch pdb data from rcsb
            $.ajax({
                url: `https://files.rcsb.org/download/${pdbId}.pdb`,
                type: 'GET',
                success: function(data) {
                    try {
                        // clear previous model and literature
                        viewer.removeAllModels();
                        clearLiterature();
                        clearRawPdb();
                        
                        // add the molecular data to the viewer
                        currentModel = viewer.addModel(data, 'pdb');
                        
                        // apply initial styling
                        updateStyle();
                        
                        // center and render
                        viewer.zoomTo();
                        viewer.render();
                        
                        // store current pdb id and fetch literature
                        currentPdbId = pdbId;
                        updateMolecularStats(currentModel);
                        fetchLiterature(pdbId);
                        displayRawPdb(data, pdbId);
                        
                        showMessage(`${pdbId} loaded successfully`, 'success');
                    } catch (error) {
                        showMessage(`Error parsing PDB data: ${error.message}`, 'error');
                    }
                },
                error: function(xhr, status, error) {
                    showMessage(`Failed to load ${pdbId}. Please check the ID and try again.`, 'error');
                }
            });
        }
        
        function loadPDBFromFile() {
            const fileInput = $('#pdb-file')[0];
            const file = fileInput.files[0];
            
            if (!file) {
                return;
            }
            
            showMessage(`Loading ${file.name}...`);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // clear previous model
                    viewer.removeAllModels();
                    
                    // add the molecular data to the viewer
                    currentModel = viewer.addModel(e.target.result, 'pdb');
                    
                    // apply initial styling
                    updateStyle();
                    
                    // center and render
                    viewer.zoomTo();
                    viewer.render();
                    
                    // clear literature for file uploads (no pdb id)
                    currentPdbId = null;
                    clearLiterature();
                    clearRawPdb();
                    displayRawPdb(e.target.result, null);
                    
                    updateMolecularStats(currentModel);
                    showMessage(`${file.name} loaded successfully`, 'success');
                } catch (error) {
                    showMessage(`Error parsing file: ${error.message}`, 'error');
                }
            };
            
            reader.onerror = function() {
                showMessage('Error reading file', 'error');
            };
            
            reader.readAsText(file);
        }
        
        function updateStyle() {
            if (!currentModel) {
                return;
            }
            
            const styleType = $('#style-select').val();
            const colorScheme = $('#color-select').val();
            
            // clear existing styles
            viewer.setStyle({}, {});
            
            // define style object
            let styleObj = {};
            styleObj[styleType] = { color: colorScheme };
            
            // apply the style
            viewer.setStyle({}, styleObj);
            
            // re-enable click handling if interactive mode is on
            if (interactiveMode) {
                enableClickHandling();
            }
            
            viewer.render();
        }
        
        function centerView() {
            if (viewer) {
                viewer.zoomTo();
                viewer.render();
                showMessage('View centered', 'success');
            }
        }
        
        function clearViewer() {
            if (viewer) {
                viewer.removeAllModels();
                viewer.render();
                currentModel = null;
                selectedAtoms = [];
                currentPdbId = null;
                updateMolecularStats(null);
                closeAminoAcidModal();
                clearLiterature();
                clearRawPdb();
                showMessage('Display cleared');
                
                // turn off interactive mode
                if (interactiveMode) {
                    interactiveMode = false;
                    const btn = $('#interactive-btn');
                    btn.text('Interactive Mode: OFF');
                    btn.css('background', '#2a2a2a');
                }
            }
        }
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        function toggleInteractiveMode() {
            interactiveMode = !interactiveMode;
            const btn = $('#interactive-btn');
            
            if (interactiveMode) {
                btn.text('Interactive Mode: ON');
                btn.css('background', '#333333');
                enableClickHandling();
                showMessage('Interactive mode enabled - click on amino acids to explore', 'success');
            } else {
                btn.text('Interactive Mode: OFF');
                btn.css('background', '#2a2a2a');
                disableClickHandling();
                closeAminoAcidModal();
                showMessage('Interactive mode disabled', 'info');
            }
        }
        
        function enableClickHandling() {
            if (!currentModel) return;
            
            // set up click handling for all atoms
            viewer.setClickable({}, true, function(atom, viewer, event, container) {
                if (interactiveMode) {
                    handleAtomClick(atom);
                }
            });
            
            viewer.render();
        }
        
        function disableClickHandling() {
            if (!currentModel) return;
            
            // clear previous selections
            clearAtomSelection();
            
            // remove click handlers
            viewer.setClickable({}, false);
            viewer.render();
        }
        
        function handleAtomClick(atom) {
            // clear previous selection
            clearAtomSelection();
            
            // highlight the clicked residue
            const residueSelector = {
                chain: atom.chain,
                resi: atom.resi
            };
            
            // add glowing highlight to the residue
            viewer.addStyle(residueSelector, {
                stick: {
                    color: '#ffff00',
                    radius: 0.4
                },
                sphere: {
                    color: '#ffff00',
                    radius: 0.6,
                    alpha: 0.8
                }
            });
            
            // store selected atoms for later clearing
            selectedAtoms = currentModel.selectedAtoms(residueSelector);
            
            viewer.render();
            
            // show amino acid details in modal
            showAminoAcidDetails(atom);
            
            showMessage(`Selected: ${getResidueFullName(atom.resn)} in chain ${atom.chain}`, 'success');
        }
        
        function clearAtomSelection() {
            if (selectedAtoms.length > 0) {
                selectedAtoms = [];
                // reapply the current style to remove highlights
                updateStyle();
            }
        }
        
        function showAminoAcidDetails(atom) {
            const residueCode = atom.resn;
            const residueName = getResidueFullName(residueCode);
            const residueData = getAminoAcidData(residueCode);
            
            // update modal title
            $('#modal-title').text(`${residueName} (${residueCode})`);
            
            // show structure
            $('#amino-acid-structure').html(`
                <div style="font-size: 14px; color: #ffffff; margin-bottom: 10px;">Chemical Structure</div>
                <div style="font-family: monospace; font-size: 24px; color: #00ff88; background: #000; padding: 15px; border-radius: 4px;">
                    ${residueData.structure}
                </div>
            `);
            
            // show information
            $('#amino-acid-info').html(`
                <div class="info-item">
                    <span class="info-label">Full Name:</span>
                    <span class="info-value">${residueName}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Code:</span>
                    <span class="info-value">${residueCode}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Chain:</span>
                    <span class="info-value">${atom.chain || 'unknown'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Position:</span>
                    <span class="info-value">${atom.resi || 'unknown'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Type:</span>
                    <span class="info-value">${residueData.type}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Properties:</span>
                    <span class="info-value">${residueData.properties}</span>
                </div>
            `);
            
            // show description
            $('#amino-acid-description').text(residueData.description);
            
            // show modal
            $('#amino-acid-modal').fadeIn(200);
        }
        
        function closeAminoAcidModal() {
            $('#amino-acid-modal').fadeOut(200);
        }
        
        function getAminoAcidData(resn) {
            const aminoAcidData = {
                'ALA': {
                    structure: 'H₃N⁺-CH(CH₃)-COO⁻',
                    type: 'Amino Acid',
                    properties: 'Nonpolar, hydrophobic',
                    description: 'Alanine is the simplest amino acid after glycine. Its methyl side chain is nonpolar and hydrophobic, making it commonly found in the interior of proteins.'
                },
                'ARG': {
                    structure: 'H₃N⁺-CH(CH₂₃-NH-C(NH₂)₂⁺)-COO⁻',
                    type: 'Amino Acid',
                    properties: 'Positively charged, basic',
                    description: 'Arginine has a positively charged guanidino group, making it basic and hydrophilic. Often found on protein surfaces and involved in binding negatively charged molecules.'
                },
                'ASN': {
                    structure: 'H₃N⁺-CH(CH₂-CONH₂)-COO⁻',
                    type: 'Amino Acid',
                    properties: 'Polar, uncharged',
                    description: 'Asparagine has an amide group that can form hydrogen bonds. Common in protein surfaces and often involved in protein-protein interactions.'
                },
                'ASP': {
                    structure: 'H₃N⁺-CH(CH₂-COO⁻)-COO⁻',
                    type: 'Amino Acid',
                    properties: 'Negatively charged, acidic',
                    description: 'Aspartic acid has a carboxyl group that is negatively charged at physiological pH. Often found on protein surfaces and involved in binding positively charged molecules.'
                },
                'CYS': {
                    structure: 'H₃N⁺-CH(CH₂-SH)-COO⁻',
                    type: 'Amino Acid',
                    properties: 'Polar, forms disulfide bonds',
                    description: 'Cysteine contains a sulfur atom that can form disulfide bonds with other cysteines, providing structural stability to proteins.'
                },
                'GLN': {
                    structure: 'H₃N⁺-CH(CH₂₂-CONH₂)-COO⁻',
                    type: 'Amino Acid',
                    properties: 'Polar, uncharged',
                    description: 'Glutamine has an amide group and is similar to asparagine but with a longer side chain. Important for protein folding and stability.'
                },
                'GLU': {
                    structure: 'H₃N⁺-CH(CH₂₂-COO⁻)-COO⁻',
                    type: 'Amino Acid',
                    properties: 'Negatively charged, acidic',
                    description: 'Glutamic acid is similar to aspartic acid but with a longer side chain. Key in enzyme active sites and protein-protein interactions.'
                },
                'GLY': {
                    structure: 'H₃N⁺-CH₂-COO⁻',
                    type: 'Amino Acid',
                    properties: 'Flexible, smallest',
                    description: 'Glycine is the smallest amino acid with just a hydrogen atom as its side chain. Provides flexibility in protein structures and often found in turns.'
                },
                'HIS': {
                    structure: 'H₃N⁺-CH(CH₂-imidazole)-COO⁻',
                    type: 'Amino Acid',
                    properties: 'Positively charged, basic',
                    description: 'Histidine has an imidazole ring that can be positively charged. Often found in enzyme active sites due to its ability to donate and accept protons.'
                },
                'ILE': {
                    structure: 'H₃N⁺-CH(CH(CH₃)CH₂CH₃)-COO⁻',
                    type: 'Amino Acid',
                    properties: 'Nonpolar, hydrophobic',
                    description: 'Isoleucine is a branched, hydrophobic amino acid. Important for protein structure and commonly found in the hydrophobic core of proteins.'
                },
                'LEU': {
                    structure: 'H₃N⁺-CH(CH₂CH(CH₃)₂)-COO⁻',
                    type: 'Amino Acid',
                    properties: 'Nonpolar, hydrophobic',
                    description: 'Leucine is a branched, hydrophobic amino acid. Very common in proteins and important for maintaining protein structure through hydrophobic interactions.'
                },
                'LYS': {
                    structure: 'H₃N⁺-CH(CH₂₄-NH₃⁺)-COO⁻',
                    type: 'Amino Acid',
                    properties: 'Positively charged, basic',
                    description: 'Lysine has a positively charged amino group. Often found on protein surfaces and involved in binding DNA and other negatively charged molecules.'
                },
                'MET': {
                    structure: 'H₃N⁺-CH(CH₂₂-S-CH₃)-COO⁻',
                    type: 'Amino Acid',
                    properties: 'Nonpolar, hydrophobic',
                    description: 'Methionine contains sulfur and is often the starting amino acid in protein synthesis. Important for protein folding and structure.'
                },
                'PHE': {
                    structure: 'H₃N⁺-CH(CH₂-benzene)-COO⁻',
                    type: 'Amino Acid',
                    properties: 'Nonpolar, aromatic',
                    description: 'Phenylalanine has a large aromatic benzene ring. Hydrophobic and often involved in protein-protein interactions through π-π stacking.'
                },
                'PRO': {
                    structure: 'H₂N⁺-cyclic-COO⁻',
                    type: 'Amino Acid',
                    properties: 'Rigid, cyclic',
                    description: 'Proline has a unique cyclic structure that restricts backbone flexibility. Often found in turns and can disrupt secondary structures.'
                },
                'SER': {
                    structure: 'H₃N⁺-CH(CH₂-OH)-COO⁻',
                    type: 'Amino Acid',
                    properties: 'Polar, uncharged',
                    description: 'Serine has a hydroxyl group that can form hydrogen bonds. Often phosphorylated for regulatory purposes and common in enzyme active sites.'
                },
                'THR': {
                    structure: 'H₃N⁺-CH(CH(OH)CH₃)-COO⁻',
                    type: 'Amino Acid',
                    properties: 'Polar, uncharged',
                    description: 'Threonine has a hydroxyl group like serine but with an additional methyl group. Can be phosphorylated and involved in protein regulation.'
                },
                'TRP': {
                    structure: 'H₃N⁺-CH(CH₂-indole)-COO⁻',
                    type: 'Amino Acid',
                    properties: 'Nonpolar, aromatic',
                    description: 'Tryptophan has the largest side chain with an indole ring. Highly hydrophobic and often involved in protein-membrane interactions.'
                },
                'TYR': {
                    structure: 'H₃N⁺-CH(CH₂-phenol)-COO⁻',
                    type: 'Amino Acid',
                    properties: 'Polar, aromatic',
                    description: 'Tyrosine has a phenol group that can form hydrogen bonds. Can be phosphorylated for signaling and involved in protein-protein interactions.'
                },
                'VAL': {
                    structure: 'H₃N⁺-CH(CH(CH₃)₂)-COO⁻',
                    type: 'Amino Acid',
                    properties: 'Nonpolar, hydrophobic',
                    description: 'Valine is a branched, hydrophobic amino acid. Important for protein structure and commonly found in the hydrophobic core of proteins.'
                },
                'A': {
                    structure: 'Adenine-Ribose-PO₄',
                    type: 'RNA Nucleotide',
                    properties: 'Purine base',
                    description: 'Adenine nucleotide in RNA. Forms two hydrogen bonds with uracil. Essential for genetic information storage and protein synthesis.'
                },
                'U': {
                    structure: 'Uracil-Ribose-PO₄',
                    type: 'RNA Nucleotide',
                    properties: 'Pyrimidine base',
                    description: 'Uracil nucleotide in RNA. Forms two hydrogen bonds with adenine. Replaces thymine in RNA molecules.'
                },
                'G': {
                    structure: 'Guanine-Ribose-PO₄',
                    type: 'RNA Nucleotide',
                    properties: 'Purine base',
                    description: 'Guanine nucleotide in RNA. Forms three hydrogen bonds with cytosine. Important for genetic stability and gene expression.'
                },
                'C': {
                    structure: 'Cytosine-Ribose-PO₄',
                    type: 'RNA Nucleotide',
                    properties: 'Pyrimidine base',
                    description: 'Cytosine nucleotide in RNA. Forms three hydrogen bonds with guanine. Essential for genetic information and protein synthesis.'
                },
                'DA': {
                    structure: 'Adenine-Deoxyribose-PO₄',
                    type: 'DNA Nucleotide',
                    properties: 'Purine base',
                    description: 'Deoxyadenosine in DNA. Forms two hydrogen bonds with thymine. Essential for genetic information storage.'
                },
                'DT': {
                    structure: 'Thymine-Deoxyribose-PO₄',
                    type: 'DNA Nucleotide',
                    properties: 'Pyrimidine base',
                    description: 'Deoxythymidine in DNA. Forms two hydrogen bonds with adenine. Unique to DNA, replaced by uracil in RNA.'
                },
                'DG': {
                    structure: 'Guanine-Deoxyribose-PO₄',
                    type: 'DNA Nucleotide',
                    properties: 'Purine base',
                    description: 'Deoxyguanosine in DNA. Forms three hydrogen bonds with cytosine. Important for genetic stability.'
                },
                'DC': {
                    structure: 'Cytosine-Deoxyribose-PO₄',
                    type: 'DNA Nucleotide',
                    properties: 'Pyrimidine base',
                    description: 'Deoxycytidine in DNA. Forms three hydrogen bonds with guanine. Essential for genetic information storage.'
                }
            };
            
            return aminoAcidData[resn] || {
                structure: 'Structure not available',
                type: 'Unknown',
                properties: 'Unknown',
                description: 'No detailed information available for this residue.'
            };
        }
        
        function getResidueFullName(resn) {
            const residueNames = {
                'ALA': 'Alanine', 'ARG': 'Arginine', 'ASN': 'Asparagine', 'ASP': 'Aspartic Acid',
                'CYS': 'Cysteine', 'GLN': 'Glutamine', 'GLU': 'Glutamic Acid', 'GLY': 'Glycine',
                'HIS': 'Histidine', 'ILE': 'Isoleucine', 'LEU': 'Leucine', 'LYS': 'Lysine',
                'MET': 'Methionine', 'PHE': 'Phenylalanine', 'PRO': 'Proline', 'SER': 'Serine',
                'THR': 'Threonine', 'TRP': 'Tryptophan', 'TYR': 'Tyrosine', 'VAL': 'Valine',
                'A': 'Adenine', 'T': 'Thymine', 'G': 'Guanine', 'C': 'Cytosine',
                'U': 'Uracil', 'DA': 'Deoxyadenosine', 'DT': 'Deoxythymidine', 
                'DG': 'Deoxyguanosine', 'DC': 'Deoxycytidine'
            };
            
            return residueNames[resn] || resn;
        }
        
        // keyboard shortcuts
        $(document).keydown(function(e) {
            // enter key to load pdb
            if (e.which === 13 && e.target.id === 'pdb-id') {
                loadPDBFromId();
            }
            
            // esc to clear
            if (e.which === 27) {
                clearViewer();
            }
        });
        
        // update file label when file is selected
        $('#pdb-file').on('change', function() {
            const fileName = this.files[0] ? this.files[0].name : 'Choose PDB File';
            $('.file-label').text(fileName.length > 25 ? fileName.substring(0, 22) + '...' : fileName);
        });
        
        // tab switching functions
        function switchTab(tabName) {
            // update tab buttons
            $('.tab-button').removeClass('active');
            $(`button[onclick="switchTab('${tabName}')"]`).addClass('active');
            
            // update tab panels
            $('.tab-panel').removeClass('active');
            $(`#${tabName}-panel`).addClass('active');
            
            // if switching to 3d view, resize viewer
            if (tabName === '3d-view' && viewer) {
                setTimeout(() => {
                    viewer.resize();
                    viewer.render();
                }, 100);
            }
            
            // if switching to raw pdb, update grid dimensions
            if (tabName === 'rawpdb' && fastGrid.viewport) {
                setTimeout(() => {
                    updateFastGridDimensions();
                    updateFastGridView();
                }, 100);
            }
        }
        
        // literature functions
        function clearLiterature() {
            $('#literature-title').text('Related Publications');
            $('#literature-info').text('Select a protein structure to view related research papers');
            $('#papers-list').html('<div class="no-literature">No structure loaded</div>');
        }
        
        function fetchLiterature(pdbId) {
            if (literatureCache[pdbId]) {
                displayLiterature(pdbId, literatureCache[pdbId]);
                return;
            }
            
            $('#literature-title').text(`Related Publications for ${pdbId}`);
            $('#literature-info').text('Loading publications...');
            $('#papers-list').html('<div class="loading-literature">Fetching literature from RCSB database...</div>');
            
            // fetch entry data from rcsb api
            $.ajax({
                url: `https://data.rcsb.org/rest/v1/core/entry/${pdbId}`,
                type: 'GET',
                success: function(data) {
                    const citations = data.citation || [];
                    if (citations.length === 0) {
                        displayNoLiterature(pdbId);
                        return;
                    }
                    
                    // fetch detailed publication info for each citation
                    const publicationPromises = citations.map(citation => {
                        if (citation.pdbx_database_id_pubmed) {
                            return fetchPubMedDetails(citation.pdbx_database_id_pubmed, citation);
                        }
                        return Promise.resolve(citation);
                    });
                    
                    Promise.all(publicationPromises).then(publications => {
                        literatureCache[pdbId] = publications.filter(pub => pub !== null);
                        displayLiterature(pdbId, literatureCache[pdbId]);
                    });
                },
                error: function() {
                    displayNoLiterature(pdbId, 'Failed to fetch publication data');
                }
            });
        }
        
        function fetchPubMedDetails(pubmedId, citation) {
            return new Promise((resolve) => {
                $.ajax({
                    url: `https://data.rcsb.org/rest/v1/core/pubmed/${pubmedId}`,
                    type: 'GET',
                    success: function(data) {
                        resolve({
                            ...citation,
                            pubmed_id: pubmedId,
                            title: data.title || citation.title,
                            authors: data.author || [],
                            journal: data.journal_abbrev || citation.journal_abbrev,
                            year: data.year || citation.year,
                            abstract: data.abstract || null,
                            doi: data.doi || citation.pdbx_database_id_doi,
                            pubmed_data: data
                        });
                    },
                    error: function() {
                        resolve(citation);
                    }
                });
            });
        }
        
        function displayLiterature(pdbId, publications) {
            $('#literature-info').text(`Found ${publications.length} publication(s) related to ${pdbId}`);
            
            if (publications.length === 0) {
                displayNoLiterature(pdbId);
                return;
            }
            
            let html = '';
            publications.forEach((pub, index) => {
                const authors = Array.isArray(pub.authors) ? 
                    pub.authors.slice(0, 3).map(a => `${a.name || a}`).join(', ') + 
                    (pub.authors.length > 3 ? ` et al.` : '') : 
                    (pub.rcsb_authors || []).slice(0, 3).join(', ') + 
                    (pub.rcsb_authors && pub.rcsb_authors.length > 3 ? ' et al.' : '');
                
                const abstract = pub.abstract || 'No abstract available.';
                
                html += `
                    <div class="paper-item" onclick="viewPaper(${index})">
                        <div class="paper-title">${pub.title || 'Untitled'}</div>
                        <div class="paper-authors">${authors || 'Unknown authors'}</div>
                        <div class="paper-journal">${pub.journal || 'Unknown journal'} ${pub.year ? `(${pub.year})` : ''}</div>
                        <div class="paper-abstract">${abstract}</div>
                        <div class="paper-actions" style="margin-top: 8px; display: flex; gap: 8px;">
                            ${pub.doi ? `<button onclick="event.stopPropagation(); window.open('https://doi.org/${pub.doi}', '_blank')" style="background: #51cf66; border: none; color: white; padding: 4px 8px; border-radius: 3px; font-size: 10px; cursor: pointer;">View Paper</button>` : ''}
                            ${pub.pubmed_id ? `<button onclick="event.stopPropagation(); window.open('https://pubmed.ncbi.nlm.nih.gov/${pub.pubmed_id}/', '_blank')" style="background: #4a9eff; border: none; color: white; padding: 4px 8px; border-radius: 3px; font-size: 10px; cursor: pointer;">PubMed</button>` : ''}
                        </div>
                    </div>
                `;
            });
            
            $('#papers-list').html(html);
        }
        
        function displayNoLiterature(pdbId, message = null) {
            $('#literature-info').text(`No publications found for ${pdbId}`);
            $('#papers-list').html(`
                <div class="no-literature">
                    <div>${message || 'No related publications found'}</div>
                    <div style="margin-top: 5px; font-size: 10px;">This structure may not have associated research papers in the database</div>
                </div>
            `);
        }
        
        function viewPaper(index) {
            if (!currentPdbId || !literatureCache[currentPdbId] || !literatureCache[currentPdbId][index]) {
                return;
            }
            
            const paper = literatureCache[currentPdbId][index];
            
            $('#paper-viewer-title').text(paper.title || 'Paper Details');
            
            let content = `
                <div class="paper-detail">
                    <h3>${paper.title || 'Untitled'}</h3>
                    
                    <div class="detail-section">
                        <div class="detail-label">Authors</div>
                        <div class="detail-value">
                            ${Array.isArray(paper.authors) ? 
                                paper.authors.map(a => a.name || a).join(', ') : 
                                (paper.rcsb_authors || []).join(', ') || 'Unknown authors'}
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-label">Journal</div>
                        <div class="detail-value">${paper.journal || 'Unknown journal'}</div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-label">Year</div>
                        <div class="detail-value">${paper.year || 'Unknown'}</div>
                    </div>
                    
                    ${paper.doi ? `
                        <div class="detail-section">
                            <div class="detail-label">DOI</div>
                            <div class="detail-value">
                                <a href="https://doi.org/${paper.doi}" target="_blank" style="color: #51cf66;">
                                    ${paper.doi}
                                </a>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${paper.pubmed_id ? `
                        <div class="detail-section">
                            <div class="detail-label">PubMed ID</div>
                            <div class="detail-value">
                                <a href="https://pubmed.ncbi.nlm.nih.gov/${paper.pubmed_id}/" target="_blank" style="color: #51cf66;">
                                    ${paper.pubmed_id}
                                </a>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${paper.abstract ? `
                        <div class="detail-section">
                            <div class="detail-label">Abstract</div>
                            <div class="detail-value" style="line-height: 1.6; color: #cccccc;">
                                ${paper.abstract}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            $('#paper-viewer-body').html(content);
            $('#paper-viewer').fadeIn(200);
        }
        
        function closePaperViewer() {
            $('#paper-viewer').fadeOut(200);
        }

        // raw pdb functions
        function clearRawPdb() {
            $('#rawpdb-title').text('Raw PDB Data');
            $('#rawpdb-info').text('Load a structure to view formatted PDB data');
            $('#rawpdb-content').html('<div class="no-rawpdb"><div>No structure loaded</div><div style="margin-top: 5px; font-size: 10px;">Load a PDB structure to view formatted data</div></div>');
            rawPdbData = null;
        }

        function displayRawPdb(pdbData, pdbId = null) {
            rawPdbData = pdbData;
            const title = pdbId ? `Raw PDB Data - ${pdbId}` : 'Raw PDB Data - Uploaded File';
            $('#rawpdb-title').text(title);
            
            const lines = pdbData.split('\n').filter(line => line.trim());
            $('#rawpdb-info').text(`${lines.length} lines of PDB data`);
            
            // initialize fast grid for performance
            initializeFastPdbGrid(lines);
        }

        function getRecordClass(recordType) {
            switch(recordType) {
                case 'HEADER':
                case 'TITLE':
                case 'COMPND':
                case 'SOURCE':
                case 'KEYWDS':
                case 'EXPDTA':
                case 'AUTHOR':
                case 'REVDAT':
                case 'JRNL':
                case 'REMARK':
                    return 'record-header';
                case 'ATOM':
                    return 'record-atom';
                case 'HETATM':
                    return 'record-hetatm';
                case 'CONECT':
                    return 'record-conect';
                default:
                    return '';
            }
        }

        // fast grid implementation inspired by gabrielpetersson/fast-grid
        function initializeFastPdbGrid(lines) {
            const startTime = performance.now();
            
            // parse data
            fastGrid.data = lines.map((line, index) => ({
                lineNumber: index + 1,
                recordType: line.substring(0, 6).trim(),
                content: line.substring(6),
                originalLine: line
            }));
            
            fastGrid.filteredData = [...fastGrid.data];
            
            // get unique record types for filters
            const recordTypes = [...new Set(fastGrid.data.map(row => row.recordType))].filter(Boolean);
            
            // create grid html structure
            const gridHtml = `
                <div class="fast-grid-container">
                    <div class="pdb-filters">
                        <span style="font-size: 11px; color: #888;">Filter by record type:</span>
                        <select class="pdb-filter-dropdown" id="pdb-filter-select" onchange="fastGridFilter(this.value)">
                            <option value="all">All Records</option>
                            ${recordTypes.sort().map(type => `<option value="${type}">${type}</option>`).join('')}
                        </select>
                    </div>
                    <div class="fast-grid-stats">
                        <span>Showing <span id="grid-visible-count">${fastGrid.filteredData.length}</span> of ${fastGrid.data.length} records</span>
                        <span class="fast-grid-performance" id="grid-performance">120 FPS</span>
                    </div>
                    <div class="fast-grid-header">
                        <div class="fast-grid-header-cell">Line</div>
                        <div class="fast-grid-header-cell">Record</div>
                        <div class="fast-grid-header-cell">Content</div>
                    </div>
                    <div class="fast-grid-viewport" id="fast-grid-viewport">
                        <div class="fast-grid-content" id="fast-grid-content"></div>
                    </div>
                </div>
            `;
            
            $('#rawpdb-content').html(gridHtml);
            
            // initialize grid components
            fastGrid.container = document.getElementById('fast-grid-content');
            fastGrid.viewport = document.getElementById('fast-grid-viewport');
            
            // setup scroll listener with throttling for performance
            let scrollTimeout;
            fastGrid.viewport.addEventListener('scroll', () => {
                if (scrollTimeout) clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(updateFastGridView, 0);
            });
            
            // initial render
            updateFastGridDimensions();
            updateFastGridView();
            
            const loadTime = (performance.now() - startTime).toFixed(1);
            $('#grid-performance').text(`Loaded in ${loadTime}ms`);
        }

        function updateFastGridDimensions() {
            fastGrid.containerHeight = fastGrid.viewport.clientHeight;
            fastGrid.visibleRowCount = Math.ceil(fastGrid.containerHeight / fastGrid.rowHeight) + fastGrid.buffer;
        }

        function updateFastGridView() {
            const scrollTop = fastGrid.viewport.scrollTop;
            const totalHeight = fastGrid.filteredData.length * fastGrid.rowHeight;
            
            // calculate visible range
            fastGrid.startIndex = Math.floor(scrollTop / fastGrid.rowHeight);
            fastGrid.endIndex = Math.min(
                fastGrid.startIndex + fastGrid.visibleRowCount,
                fastGrid.filteredData.length
            );
            
            // set container height to create proper scrollbar
            fastGrid.container.style.height = `${totalHeight}px`;
            
            // clear existing rows
            fastGrid.container.innerHTML = '';
            
            // render visible rows only
            for (let i = fastGrid.startIndex; i < fastGrid.endIndex; i++) {
                const row = fastGrid.filteredData[i];
                if (!row) continue;
                
                const rowElement = createFastGridRow(row, i);
                fastGrid.container.appendChild(rowElement);
            }
            
            // update performance indicator
            const fps = Math.min(120, 1000 / (performance.now() - (fastGrid.lastRender || performance.now())));
            $('#grid-performance').text(`${Math.round(fps)} FPS`);
            fastGrid.lastRender = performance.now();
        }

        function createFastGridRow(rowData, index) {
            const row = document.createElement('div');
            row.className = 'fast-grid-row';
            row.style.top = `${index * fastGrid.rowHeight}px`;
            
            const recordClass = getRecordClass(rowData.recordType);
            
            row.innerHTML = `
                <div class="fast-grid-cell">${rowData.lineNumber}</div>
                <div class="fast-grid-cell record-type ${recordClass}">${rowData.recordType}</div>
                <div class="fast-grid-cell">${rowData.content.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
            `;
            
            return row;
        }

        function fastGridFilter(recordType) {
            const startTime = performance.now();
            
            // update dropdown selection
            const dropdown = document.getElementById('pdb-filter-select');
            if (dropdown && dropdown.value !== recordType) {
                dropdown.value = recordType;
            }
            
            // filter data
            if (recordType === 'all') {
                fastGrid.filteredData = [...fastGrid.data];
            } else {
                fastGrid.filteredData = fastGrid.data.filter(row => row.recordType === recordType);
            }
            
            fastGrid.currentFilter = recordType;
            
            // reset scroll position
            fastGrid.viewport.scrollTop = 0;
            
            // update view
            updateFastGridView();
            
            // update stats
            $('#grid-visible-count').text(fastGrid.filteredData.length);
            
            const filterTime = (performance.now() - startTime).toFixed(1);
            $('#grid-performance').text(`Filtered in ${filterTime}ms`);
        }

        function filterPdbRecords(recordType) {
            // legacy function - redirect to fast grid
            fastGridFilter(recordType);
        }
    </script>
</body>
</html>